var jaws=function(t){return t.Rect=function(t,i,e,s){this.x=t,this.y=i,this.width=e,this.height=s,this.right=t+e,this.bottom=i+s},t.Rect.prototype.getPosition=function(){return[this.x,this.y]},t.Rect.prototype.move=function(t,i){this.x+=t,this.y+=i,this.right+=t,this.bottom+=i},t.Rect.prototype.moveTo=function(t,i){return this.x=t,this.y=i,this.right=this.x+this.width,this.bottom=this.y+this.height,this},t.Rect.prototype.resize=function(t,i){return this.width+=t,this.height+=i,this.right=this.x+this.width,this.bottom=this.y+this.height,this},t.Rect.prototype.resizeTo=function(t,i){return this.width=t,this.height=i,this.right=this.x+this.width,this.bottom=this.y+this.height,this},t.Rect.prototype.draw=function(){return t.context.strokeStyle="red",t.context.strokeRect(this.x,this.y,this.width,this.height),this},t.Rect.prototype.collidePoint=function(t,i){return t>=this.x&&t<=this.right&&i>=this.y&&i<=this.bottom},t.Rect.prototype.collideRect=function(t){return(this.x>=t.x&&this.x<=t.right||t.x>=this.x&&t.x<=this.right)&&(this.y>=t.y&&this.y<=t.bottom||t.y>=this.y&&t.y<=this.bottom)},t.Rect.prototype.toString=function(){return"[Rect "+this.x+", "+this.y+", "+this.width+", "+this.height+"]"},t}((jaws=function(t){function i(t){this.size=t,this.values=new Array(this.size),this.value,this.add=function(t){if(this.values.length>this.size){this.values.splice(0,1),this.value=0;for(var i=0;this.values[i];i++)this.value+=this.values[i];this.value=this.value/this.size}return this.values.push(t),this},this.get=function(){return parseInt(this.value)}}return t.GameLoop=function(e,s,o,r){var n;this.ticks=0,this.tick_duration=0,this.fps=0;var a=!1,h=this,c=new i(20);this.start=function(){t.log("gameloop start",!0),this.current_tick=(new Date).getTime(),this.last_tick=(new Date).getTime(),e&&e(),n=setInterval(this.loop,1e3/r),t.log("gameloop loop",!0)},this.loop=function(){h.current_tick=(new Date).getTime(),h.tick_duration=h.current_tick-h.last_tick,h.fps=c.add(1e3/h.tick_duration).get(),a||(s&&s(),o&&o(),h.ticks++),h.last_tick=h.current_tick},this.pause=function(){a=!0},this.unpause=function(){a=!1},this.stop=function(){n&&clearInterval(n)}},t}((jaws=function(t){function e(t){var i=document.createElement("canvas");return i.src=t.src,i.width=t.width,i.height=t.height,i.getContext("2d").drawImage(t,0,0,t.width,t.height),i}return t.Assets=function(){this.loaded=[],this.loading=[],this.src_list=[],this.data=[],this.image_to_canvas=!0,this.fuchia_to_transparent=!0,this.root="",this.file_type={},this.file_type.json="json",this.file_type.wav="audio",this.file_type.mp3="audio",this.file_type.ogg="audio",this.file_type.png="image",this.file_type.jpg="image",this.file_type.jpeg="image",this.file_type.gif="image",this.file_type.bmp="image",this.file_type.tiff="image";var s=this;this.length=function(){return this.src_list.length},this.get=function(i){return t.isArray(i)?i.map((function(t){return s.data[t]})):this.loaded[i]?this.data[i]:void t.log("No such asset: "+i)},this.isLoading=function(t){return this.loading[t]},this.isLoaded=function(t){return this.loaded[t]},this.getPostfix=function(t){return postfix_regexp=/\.([a-zA-Z]+)/,postfix_regexp.exec(t)[1]},this.getType=function(t){var i=this.getPostfix(t);return this.file_type[i]?this.file_type[i]:i},this.add=function(i){if(t.isArray(i))for(var e=0;i[e];e++)this.add(i[e]);else i=this.root+i,this.src_list.push(i);return this},this.loadAll=function(t){for(this.load_count=0,this.error_count=0,this.onload=t.onload,this.onerror=t.onerror,this.onfinish=t.onfinish,i=0;this.src_list[i];i++)this.load(this.src_list[i])},this.getOrLoad=function(t,i,e){this.data[t]?i():this.load(t,i,e)},this.load=function(t,i,e){var s={};switch(s.src=t,s.onload=i,s.onerror=e,this.loading[t]=!0,this.getType(s.src)){case"image":t=s.src+"?"+parseInt(1e7*Math.random());s.image=new Image,s.image.asset=s,s.image.onload=this.assetLoaded,s.image.onerror=this.assetError,s.image.src=t;break;case"audio":t=s.src+"?"+parseInt(1e7*Math.random());s.audio=new Audio(t),s.audio.asset=s,this.data[s.src]=s.audio,s.audio.addEventListener("canplay",this.assetLoaded,!1),s.audio.addEventListener("error",this.assetError,!1),s.audio.load();break;default:t=s.src+"?"+parseInt(1e7*Math.random());var o=new XMLHttpRequest;o.asset=s,o.onreadystatechange=this.assetLoaded,o.open("GET",t,!0),o.send(null)}},this.assetLoaded=function(i){var o=this.asset,r=o.src,n=s.getType(o.src);if(s.loaded[r]=!0,s.loading[r]=!1,"json"==n){if(4!=this.readyState)return;s.data[o.src]=JSON.parse(this.responseText)}else if("image"==n){var a=s.image_to_canvas?e(o.image):o.image;s.fuchia_to_transparent&&"bmp"==s.getPostfix(o.src)&&(a=function(i){canvas=t.isImage(i)?e(i):i;for(var s=canvas.getContext("2d"),o=s.getImageData(0,0,canvas.width,canvas.height),r=o.data,n=0;n<r.length;n+=4)255==r[n]&&0==r[n+1]&&255==r[n+2]&&(r[n+3]=0);return s.putImageData(o,0,0),canvas}(a)),s.data[o.src]=a}else"audio"==n&&(o.audio.removeEventListener("canplay",s.assetLoaded,!1),s.data[o.src]=o.audio);s.load_count++,o.onload&&o.onload(),s.processCallbacks(o)},this.assetError=function(t){var i=this.asset;s.error_count++,i.onerror&&i.onerror(i),s.processCallbacks(i)},this.processCallbacks=function(t){var i=parseInt((s.load_count+s.error_count)/s.src_list.length*100);s.onload&&s.onload(t.src,i),100==i&&(s.onfinish&&s.onfinish(),s.onload=null,s.onerror=null,s.onfinish=null)}},t.assets=new t.Assets,t}((jaws=function(t){var i={},e=[],s=[],o=[];t.setupInput=function(){var t=[];t[8]="backspace",t[9]="tab",t[13]="enter",t[16]="shift",t[17]="ctrl",t[18]="alt",t[19]="pause",t[20]="capslock",t[27]="esc",t[32]="space",t[33]="pageup",t[34]="pagedown",t[35]="end",t[36]="home",t[37]="left",t[38]="up",t[39]="right",t[40]="down",t[45]="insert",t[46]="delete",t[91]="leftwindowkey",t[92]="rightwindowkey",t[93]="selectkey",t[106]="multiply",t[107]="add",t[109]="subtract",t[110]="decimalpoint",t[111]="divide",t[144]="numlock",t[145]="scrollock",t[186]="semicolon",t[187]="equalsign",t[188]="comma",t[189]="dash",t[190]="period",t[191]="forwardslash",t[192]="graveaccent",t[219]="openbracket",t[220]="backslash",t[221]="closebracket",t[222]="singlequote";for(var n=["numpad1","numpad2","numpad3","numpad4","numpad5","numpad6","numpad7","numpad8","numpad9"],a=["f1","f2","f3","f4","f5","f6","f7","f8","f9"],h=["0","1","2","3","4","5","6","7","8","9"],c=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],l=0;h[l];l++)t[48+l]=h[l];for(l=0;c[l];l++)t[65+l]=c[l];for(l=0;n[l];l++)t[96+l]=n[l];for(l=0;a[l];l++)t[112+l]=a[l];e=t,window.onkeydown=function(t){!function(t){event=t||window.event;var o=e[event.keyCode];i[o]=!0,s[o]&&(s[o](),t.preventDefault());r[o]&&t.preventDefault()}(t)},window.onkeyup=function(t){!function(t){event=t||window.event;var s=e[event.keyCode];i[s]=!1,o[s]&&(o[s](),t.preventDefault());r[s]&&t.preventDefault()}(t)},window.onkeypress=function(t){}};var r=[];return t.preventDefaultKeys=function(t){t.forEach((function(t,i){r[t]=!0}))},t.pressed=function(t){return i[t]},t.on_keydown=function(i,e){if(t.isArray(i))for(var o=0;i[o];o++)s[i[o]]=e;else s[i]=e},t.on_keyup=function(i,e){if(t.isArray(i))for(var s=0;i[s];s++)o[i[s]]=e;else o[i]=e},t.clearKeyCallbacks=function(){o=[],s=[]},t}((jaws=function(t){var i,e;return t.title=function(t){return t?i.innerHTML=t:i.innerHTML},t.unpack=function(){["Sprite","SpriteList","Animation","Viewport","SpriteSheet","Parallax","TileMap","Rect","pressed"].forEach((function(i,e,s){window[i]?t.log(i+"already exists in global namespace"):window[i]=t[i]}))},t.log=function(t,i){e&&(t+="<br />",e.innerHTML=i?e.innerHTML.toString()+t:t)},t.init=function(s){i=document.getElementsByTagName("title")[0],t.url_parameters=function(){for(var t,i=[],e=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),s=0;s<e.length;s++)t=e[s].split("="),i.push(t[0]),i[t[0]]=t[1];return i}(),e=document.getElementById("jaws-log"),t.url_parameters.debug&&(e||((e=document.createElement("div")).style.cssText="overflow: auto; color: #aaaaaa; width: 300px; height: 150px; margin: 40px auto 0px auto; padding: 5px; border: #444444 1px solid; clear: both; font: 10px verdana; text-align: left;",document.body.appendChild(e))),t.canvas=document.getElementsByTagName("canvas")[0],t.canvas?t.context=t.canvas.getContext("2d"):(t.dom=document.getElementById("canvas"),t.dom.style.position="relative"),t.width=t.canvas?t.canvas.width:t.dom.offsetWidth,t.height=t.canvas?t.canvas.height:t.dom.offsetHeigh},t.start=function(i,e){var s=e&&e.fps||60;function o(){t.log("all assets loaded",!0),i&&t.isFunction(i)&&(i=new i),i||(i=window),t.gameloop=new t.GameLoop(i.setup,i.update,i.draw,s),t.game_state=i,t.gameloop.start()}t.init(),t.log("setupInput()",!0),t.setupInput(),t.log("assets.loadAll()",!0),t.assets.length()>0?t.assets.loadAll({onload:function(i,e){t.log(e+"%: "+i,!0)},onerror:function(i){t.log("Error loading: "+i)},onfinish:o}):o()},t.switchGameState=function(i){t.gameloop.stop(),t.clearKeyCallbacks(),t.isFunction(i)&&(i=new i),t.previous_game_state=t.game_state,t.game_state=i,t.gameloop=new t.GameLoop(i.setup,i.update,i.draw,t.gameloop.fps),t.gameloop.start()},t.forceArray=function(t){return Array.isArray(t)?t:[t]},t.clear=function(){t.context.clearRect(0,0,t.width,t.height)},t.isImage=function(t){return"[object HTMLImageElement]"===Object.prototype.toString.call(t)},t.isCanvas=function(t){return"[object HTMLCanvasElement]"===Object.prototype.toString.call(t)},t.isDrawable=function(i){return t.isImage(i)||t.isCanvas(i)},t.isString=function(t){return"string"==typeof t},t.isArray=function(t){return!(-1==t.constructor.toString().indexOf("Array"))},t.isFunction=function(t){return"[object Function]"===Object.prototype.toString.call(t)},t}(jaws||{}))||{}))||{}))||{}))||{});"undefined"!=typeof module&&"exports"in module&&(module.exports=jaws.Rect);jaws=function(t){return t.TileMap=function(t){this.cell_size=t.cell_size||[32,32],this.size=t.size,this.cells=new Array(this.size[0]),this.sortFunction=void 0;for(var i=0;i<this.size[0];i++){this.cells[i]=new Array(this.size[1]);for(var e=0;e<this.size[1];e++)this.cells[i][e]=[]}},t.TileMap.prototype.clear=function(){for(var t=0;t<this.size[0];t++)for(var i=0;i<this.size[1];i++)this.cells[t][i]=[]},t.TileMap.prototype.sortCells=function(t){for(var i=0;i<this.size[0];i++)for(var e=0;e<this.size[1];e++)this.cells[i][e].sort(t)},t.TileMap.prototype.push=function(t){if(t.length){for(var i=0;i<t.length;i++)this.push(t[i]);return t}if(t.rect)return this.pushAsRect(t,t.rect());var e=parseInt(t.x/this.cell_size[0]),s=parseInt(t.y/this.cell_size[1]);return this.pushToCell(e,s,t)},t.TileMap.prototype.pushAsPoint=function(t){if(Array.isArray(t)){for(var i=0;i<t.length;i++)this.pushAsPoint(t[i]);return t}var e=parseInt(t.x/this.cell_size[0]),s=parseInt(t.y/this.cell_size[1]);return this.pushToCell(e,s,t)},t.TileMap.prototype.pushAsRect=function(t,i){for(var e=parseInt(i.x/this.cell_size[0]),s=parseInt((i.right-1)/this.cell_size[0]),o=e;o<=s;o++)for(var r=parseInt(i.y/this.cell_size[1]),n=parseInt((i.bottom-1)/this.cell_size[1]),a=r;a<=n;a++)this.pushToCell(o,a,t);return t},t.TileMap.prototype.pushToCell=function(t,i,e){return this.cells[t][i].push(e),this.sortFunction&&this.cells[t][i].sort(this.sortFunction),this},t.TileMap.prototype.at=function(t,i){var e=parseInt(t/this.cell_size[0]),s=parseInt(i/this.cell_size[1]);return this.cells[e][s]},t.TileMap.prototype.atRect=function(t){for(var i=[],e=parseInt(t.x/this.cell_size[0]),s=parseInt(t.right/this.cell_size[0]),o=e;o<=s;o++)for(var r=parseInt(t.y/this.cell_size[1]),n=parseInt(t.bottom/this.cell_size[1]),a=r;a<=n;a++)this.cells[o][a].forEach((function(t,e){-1==i.indexOf(t)&&i.push(t)}));return i},t.TileMap.prototype.all=function(){for(var t=[],i=0;i<this.size[0];i++)for(var e=0;e<this.size[1];e++)this.cells[i][e].forEach((function(i,e){t.push(i)}));return t},t.TileMap.prototype.cell=function(t,i){return this.cells[t][i]},t.TileMap.prototype.toString=function(){return"[TileMap "+this.size[0]+" cols, "+this.size[1]+" rows]"},t}((jaws=function(t){return t.Viewport=function(i){this.options=i,this.context=i.context||t.context,this.width=i.width||t.width,this.height=i.height||t.height,this.max_x=i.max_x||t.width,this.max_y=i.max_y||t.height,this.verifyPosition=function(){var t=this.max_x-this.width;this.x<0&&(this.x=0),this.x>t&&(this.x=t);t=this.max_y-this.height;this.y<0&&(this.y=0),this.y>t&&(this.y=t)},this.move=function(t,i){t&&(this.x+=t),i&&(this.y+=i),this.verifyPosition()},this.moveTo=function(t,i){null!=t&&(this.x=t),null!=i&&(this.y=i),this.verifyPosition()},this.isOutside=function(t){return!this.isInside(t)},this.isInside=function(t){return t.x>=this.x&&t.x<=this.x+this.width&&t.y>=this.y&&t.y<=this.y+this.height},this.centerAround=function(t){this.x=t.x-this.width/2,this.y=t.y-this.height/2,this.verifyPosition()},this.apply=function(t){this.context.save(),this.context.translate(-this.x,-this.y),t(),this.context.restore()},this.moveTo(i.x||0,i.y||0)},t.Viewport.prototype.toString=function(){return"[Viewport "+this.x+", "+this.y+","+this.width+","+this.height+"]"},t}((jaws=function(t){return t.Animation=function(i){if(this.options=i,this.frames=i.frames||[],this.frame_duration=i.frame_duration||100,this.index=i.index||0,this.loop=i.loop||1,this.bounce=i.bounce||0,this.frame_direction=1,i.sprite_sheet){var e=t.isDrawable(i.sprite_sheet)?i.sprite_sheet:t.assets.get(i.sprite_sheet),s=new t.SpriteSheet({image:e,frame_size:i.frame_size});this.frames=s.frames}this.current_tick=(new Date).getTime(),this.last_tick=(new Date).getTime(),this.sum_tick=0},t.Animation.prototype.update=function(){return this.current_tick=(new Date).getTime(),this.sum_tick+=this.current_tick-this.last_tick,this.last_tick=this.current_tick,this.sum_tick>this.frame_duration&&(this.index+=this.frame_direction,this.sum_tick=0),(this.index>=this.frames.length||this.index<=0)&&(this.bounce?(this.frame_direction=-this.frame_direction,this.index+=2*this.frame_direction):this.loop&&(this.index=0)),this},t.Animation.prototype.slice=function(i,e){var s={};return s.frame_duration=this.frame_duration,s.loop=this.loop,s.bounce=this.bounce,s.frame_direction=this.frame_direction,s.frames=this.frames.slice().slice(i,e),new t.Animation(s)},t.Animation.prototype.next=function(){return this.update(),this.frames[this.index]},t.Animation.prototype.currentFrame=function(){return this.frames[this.index]},t.Animation.prototype.toString=function(){return"[Animation, "+this.frames.length+" frames]"},t}((jaws=function(t){return t.Parallax=function(t){this.scale=t.scale||1,this.repeat_x=t.repeat_x,this.repeat_y=t.repeat_y,this.camera_x=t.camera_x||0,this.camera_y=t.camera_y||0,this.layers=[]},t.Parallax.prototype.draw=function(i){for(var e,s,o,r=0;r<this.layers.length;r++){for(s=(e=this.layers[r]).x,o=e.y,e.x=-this.camera_x/e.damping,e.y=-this.camera_y/e.damping;this.repeat_x&&e.x>0;)e.x-=e.width;for(;this.repeat_y&&e.y>0;)e.y-=e.width;for(;this.repeat_x&&e.x<t.width;){for(;this.repeat_y&&e.y<t.height;)e.draw(),e.y+=e.height;e.y=o,e.draw(),e.x+=e.width-1}for(;e.repeat_y&&!e.repeat_x&&e.y<t.height;)e.draw(),e.y+=e.height;e.x=s}},t.Parallax.prototype.addLayer=function(i){var e=new t.ParallaxLayer(i);e.scale(this.scale),this.layers.push(e)},t.Parallax.prototype.toString=function(){return"[Parallax "+this.x+", "+this.y+". "+this.layers.length+" layers]"},t.ParallaxLayer=function(i){this.damping=i.damping||0,t.Sprite.call(this,i)},t.ParallaxLayer.prototype=t.Sprite.prototype,t.Parallax.prototype.toString=function(){return"[ParallaxLayer "+this.x+", "+this.y+"]"},t}((jaws=function(t){function i(t,i,e,s,o){var r=document.createElement("canvas");return r.width=s,r.height=o,r.getContext("2d").drawImage(t,i,e,s,o,0,0,r.width,r.height),r}return t.SpriteSheet=function(e){this.image=t.isDrawable(e.image)?e.image:t.assets.data[e.image],this.orientation=e.orientation||"right",this.frame_size=e.frame_size||[32,32],this.frames=[];for(var s=0;s<this.image.width;s+=this.frame_size[0])for(var o=0;o<this.image.height;o+=this.frame_size[1])this.frames.push(i(this.image,s,o,this.frame_size[0],this.frame_size[1]))},t.SpriteSheet.prototype.toString=function(){return"[SpriteSheet "+this.frames.length+" frames]"},t}((jaws=function(t){return t.SpriteList=function(){},t.SpriteList.prototype=new Array,t.SpriteList.prototype.remove=function(t){var i=this.indexOf(t);i>-1&&this.splice(i,1)},t.SpriteList.prototype.draw=function(){for(i=0;this[i];i++)this[i].draw()},t.SpriteList.prototype.drawIf=function(t){for(i=0;this[i];i++)t(this[i])&&this[i].draw()},t.SpriteList.prototype.update=function(){for(i=0;this[i];i++)this[i].update()},t.SpriteList.prototype.updateIf=function(t){for(i=0;this[i];i++)t(this[i])&&this[i].update()},t.SpriteList.prototype.deleteIf=function(t){for(var i=0;this[i];i++)t(this[i])&&this.splice(i,1)},t.SpriteList.prototype.toString=function(){return"[SpriteList "+this.length+" sprites]"},t}((jaws=function(t){return t.Sprite=function(i){this.options=i,this.set(i),this.context=i.context||t.context,this.context||this.createDiv()},t.Sprite.prototype.set=function(t){return this.scale_factor_x=this.scale_factor_y=t.scale||1,null==!t.anchor_x&&(this.anchor_x=t.anchor_x),null==!t.anchor_y&&(this.anchor_y=t.anchor_y),this.x=t.x||0,this.y=t.y||0,this.alpha=t.alpha||1,this.angle=t.angle||0,this.flipped=t.flipped||!1,this.anchor(t.anchor||"top_left"),t.image&&this.setImage(t.image),this.cacheOffsets(),this},t.Sprite.prototype.setImage=function(i){var e=this;return t.isDrawable(i)?(this.image=i,this.cacheOffsets()):(t.assets.isLoaded(i)?(this.image=t.assets.get(i),this.cacheOffsets()):t.assets.load(i,(function(){e.image=t.assets.get(i),e.cacheOffsets()})),this)},t.Sprite.prototype.flip=function(){return this.flipped=!this.flipped,this},t.Sprite.prototype.flipTo=function(t){return this.flipped=t,this},t.Sprite.prototype.rotate=function(t){return this.angle+=t,this},t.Sprite.prototype.rotateTo=function(t){return this.angle=t,this},t.Sprite.prototype.moveTo=function(t,i){return this.x=t,this.y=i,this},t.Sprite.prototype.move=function(t,i){return t&&(this.x+=t),i&&(this.y+=i),this},t.Sprite.prototype.scale=function(t){return this.scale_factor_x*=t,this.scale_factor_y*=t,this.cacheOffsets()},t.Sprite.prototype.scaleTo=function(t){return this.scale_factor_x=this.scale_factor_y=t,this.cacheOffsets()},t.Sprite.prototype.scaleWidth=function(t){return this.scale_factor_x*=t,this.cacheOffsets()},t.Sprite.prototype.scaleHeight=function(t){return this.scale_factor_y*=t,this.cacheOffsets()},t.Sprite.prototype.setX=function(t){return this.x=t,this},t.Sprite.prototype.setY=function(t){return this.y=t,this},t.Sprite.prototype.setWidth=function(t){return this.scale_factor_x=t/this.image.width,this.cacheOffsets()},t.Sprite.prototype.setHeight=function(t){return this.scale_factor_y=t/this.image.height,this.cacheOffsets()},t.Sprite.prototype.resize=function(t,i){return this.scale_factor_x=(this.width+t)/this.image.width,this.scale_factor_y=(this.height+i)/this.image.height,this.cacheOffsets()},t.Sprite.prototype.resizeTo=function(t,i){return this.scale_factor_x=t/this.image.width,this.scale_factor_y=i/this.image.height,this.cacheOffsets()},t.Sprite.prototype.anchor=function(t){return(a={top_left:[0,0],left_top:[0,0],center_left:[0,.5],left_center:[0,.5],bottom_left:[0,1],left_bottom:[0,1],top_center:[.5,0],center_top:[.5,0],center_center:[.5,.5],center:[.5,.5],bottom_center:[.5,1],center_bottom:[.5,1],top_right:[1,0],right_top:[1,0],center_right:[1,.5],right_center:[1,.5],bottom_right:[1,1],right_bottom:[1,1]}[t])&&(this.anchor_x=a[0],this.anchor_y=a[1],this.image&&this.cacheOffsets()),this},t.Sprite.prototype.cacheOffsets=function(){if(this.image)return this.width=this.image.width*this.scale_factor_x,this.height=this.image.height*this.scale_factor_y,this.left_offset=this.width*this.anchor_x,this.top_offset=this.height*this.anchor_y,this.right_offset=this.width*(1-this.anchor_x),this.bottom_offset=this.height*(1-this.anchor_y),this.cached_rect&&this.cached_rect.resizeTo(this.width,this.height),this},t.Sprite.prototype.rect=function(){return this.cached_rect||(this.cached_rect=new t.Rect(this.x,this.top,this.width,this.height)),this.cached_rect.moveTo(this.x-this.left_offset,this.y-this.top_offset),this.cached_rect},t.Sprite.prototype.createDiv=function(){this.div=document.createElement("div"),this.div.style.position="absolute",this.image&&(this.div.style.width=this.image.width+"px",this.div.style.height=this.image.height+"px",this.div.style.backgroundImage="url("+this.image.src+")"),t.dom&&t.dom.appendChild(this.div),this.updateDiv()},t.Sprite.prototype.updateDiv=function(){this.div.style.left=this.x+"px",this.div.style.top=this.y+"px";var t="";return t+="rotate("+this.angle+"deg) ",this.flipped?t+="scale(-"+this.scale_factor_x+","+this.scale_factor_y+")":t+="scale("+this.scale_factor_x+","+this.scale_factor_y+")",this.div.style.MozTransform=t,this.div.style.WebkitTransform=t,this.div.style.transform=t,this},t.Sprite.prototype.draw=function(){return this.image?t.dom?this.updateDiv():(this.context.save(),this.context.translate(this.x,this.y),0!=this.angle&&t.context.rotate(this.angle*Math.PI/180),this.flipped&&this.context.scale(-1,1),this.context.globalAlpha=this.alpha,this.context.translate(-this.left_offset,-this.top_offset),this.context.drawImage(this.image,0,0,this.width,this.height),this.context.restore(),this):this},t.Sprite.prototype.asCanvasContext=function(){var i=document.createElement("canvas");i.width=this.width,i.height=this.height;var e=i.getContext("2d");return e.mozImageSmoothingEnabled=t.context.mozImageSmoothingEnabled,e.drawImage(this.image,0,0,this.width,this.height),e},t.Sprite.prototype.toString=function(){return"[Sprite "+this.x+", "+this.y+","+this.width+","+this.height+"]"},t}(jaws||{}))||{}))||{}))||{}))||{}))||{}))||{});"undefined"!=typeof module&&"exports"in module&&(module.exports=jaws.TileMap);var BLOCK_WIDTH=24;function Block(t){var i,e;for(e in t=t||{},this.boX=(t.boardOriginX||0)+FIELD_OFFSET_X,this.boY=(t.boardOriginY||0)+FIELD_OFFSET_Y,this.blockX=t.blockX,this.blockY=t.blockY,this.occupiedPositions=t.occupiedPositions,this.addOccupied(this.blockX,this.blockY),Block.invalidSpaces[this.blockX+","+this.blockY]=!0,t.x=this.boX+BLOCK_WIDTH*this.blockX,t.y=this.boY+BLOCK_WIDTH*this.blockY,t.preview?t.image="media/greyblock.png":t.empty?t.image="media/emptyblock.png":t.image=SHAPES[t.shape].image,i=new jaws.Sprite(t))this[e]=i[e]}Block.invalidSpaces={},Block.allInvalidated=!1,Block.invalidFlushed=function(){Block.invalidSpaces={},Block.allInvalidated=!1},Block.invalidateAll=function(){Block.allInvalidated=!0},Block.prototype.setColor=function(t,i){i?this.setImage("media/greyblock.png"):this.setImage(SHAPES[t].image),Block.invalidSpaces[this.blockX+","+this.blockY]=!0},Block.prototype.moveBlock=function(t,i){Block.invalidSpaces[this.blockX+","+this.blockY]=!0,this.removeOccupied(this.blockX,this.blockY),this.blockX+=t,this.blockY+=i,Block.invalidSpaces[this.blockX+","+this.blockY]=!0,this.addOccupied(this.blockX,this.blockY),this.x+=t*BLOCK_WIDTH,this.y+=i*BLOCK_WIDTH},Block.prototype.setPosition=function(t,i){Block.invalidSpaces[this.blockX+","+this.blockY]=!0,this.removeOccupied(this.blockX,this.blockY),this.blockX=t,this.blockY=i,Block.invalidSpaces[this.blockX+","+this.blockY]=!0,this.addOccupied(this.blockX,this.blockY),this.x=this.boX+t*BLOCK_WIDTH,this.y=this.boY+i*BLOCK_WIDTH},Block.prototype.getX=function(){return this.blockX},Block.prototype.getY=function(){return this.blockY},Block.prototype.isPosition=function(t,i){return this.blockX===t&&this.blockY===i},Block.prototype.drawIfInvalid=function(){(Block.invalidSpaces[this.blockX+","+this.blockY]||Block.allInvalidated||this.blockY<0)&&this.draw()},Block.prototype.kill=function(){Block.invalidSpaces[this.blockX+","+this.blockY]=!0,this.removeOccupied(this.blockX,this.blockY)},Block.prototype.removeOccupied=function(t,i){var e=t+","+i;this.occupiedPositions&&this.occupiedPositions[e]&&(this.occupiedPositions[e]-=1)},Block.prototype.addOccupied=function(t,i){var e=t+","+i;this.occupiedPositions&&(void 0===this.occupiedPositions[e]&&(this.occupiedPositions[e]=0),this.occupiedPositions[e]+=1)};var SHAPES={i:{spin:"corner",startX:5,startY:0,pos:[{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1}],image:"media/cyanblock.png",kickType:"i_block"},o:{spin:"corner",startX:5,startY:-1,pos:[{x:-1,y:0},{x:0,y:0},{x:-1,y:-1},{x:0,y:-1}],image:"media/yellowblock.png",kickType:"standard"},j:{spin:"block",startX:4,startY:-1,pos:[{x:-1,y:-1},{x:-1,y:0},{x:0,y:0},{x:1,y:0}],image:"media/blueblock.png",kickType:"standard"},l:{spin:"block",startX:4,startY:-1,pos:[{x:-1,y:0},{x:0,y:0},{x:1,y:0},{x:1,y:-1}],image:"media/orangeblock.png",kickType:"standard"},s:{spin:"block",startX:4,startY:-1,pos:[{x:-1,y:0},{x:0,y:0},{x:0,y:-1},{x:1,y:-1}],image:"media/greenblock.png",kickType:"standard"},z:{spin:"block",startX:4,startY:-1,pos:[{x:-1,y:-1},{x:0,y:-1},{x:0,y:0},{x:1,y:0}],image:"media/redblock.png",kickType:"standard"},t:{spin:"block",startX:4,startY:-1,pos:[{x:-1,y:0},{x:0,y:0},{x:0,y:-1},{x:1,y:0}],image:"media/purpleblock.png",kickType:"standard"}},WALL_KICK_OFFSETS={};function ControlGroup(t,i,e){var s,o,r,n;for(n=SHAPES[i],this.pos=n.pos,this.spin=n.spin,this.bottomed=!1,this.blocks=t,this.baseX=n.startX,this.baseY=n.startY,this.shape=i,this.kickOffsets=WALL_KICK_OFFSETS[n.kickType],this.dir=0,this.isIllegalStart=!1,this.isLegalCallback=e||function(){return!0},this.lastWasSpin=!1,s=0;s<t.length;s+=1)o=this.baseX+this.pos[s].x,r=this.baseY+this.pos[s].y,this.isLegalCallback(o,r)||(this.isIllegalStart=!0),this.blocks[s].setPosition(o,r);this.updateBottomedState()}WALL_KICK_OFFSETS.standard=[{cw:[{x:0,y:0},{x:-1,y:0},{x:-1,y:-1},{x:0,y:2},{x:-1,y:2}],ccw:[{x:0,y:0},{x:1,y:0},{x:1,y:-1},{x:0,y:2},{x:1,y:2}]},{cw:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:0,y:-2},{x:1,y:-2}],ccw:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:0,y:-2},{x:1,y:-2}]},{cw:[{x:0,y:0},{x:1,y:0},{x:1,y:-1},{x:0,y:2},{x:1,y:2}],ccw:[{x:0,y:0},{x:-1,y:0},{x:-1,y:-1},{x:0,y:2},{x:-1,y:2}]},{cw:[{x:0,y:0},{x:-1,y:0},{x:-1,y:1},{x:0,y:-2},{x:-1,y:-2}],ccw:[{x:0,y:0},{x:-1,y:0},{x:-1,y:1},{x:0,y:-2},{x:-1,y:-2}]}],WALL_KICK_OFFSETS.i_block=[{cw:[{x:0,y:0},{x:-2,y:0},{x:1,y:0},{x:-2,y:1},{x:1,y:-2}],ccw:[{x:0,y:0},{x:-1,y:0},{x:2,y:0},{x:-1,y:-2},{x:2,y:1}]},{cw:[{x:0,y:0},{x:-1,y:0},{x:2,y:0},{x:-1,y:-2},{x:2,y:1}],ccw:[{x:0,y:0},{x:2,y:0},{x:-1,y:0},{x:2,y:-1},{x:-1,y:2}]},{cw:[{x:0,y:0},{x:2,y:0},{x:-1,y:0},{x:2,y:-1},{x:-1,y:2}],ccw:[{x:0,y:0},{x:1,y:0},{x:-2,y:0},{x:1,y:2},{x:-2,y:-1}]},{cw:[{x:0,y:0},{x:1,y:0},{x:-2,y:0},{x:1,y:2},{x:-2,y:1}],ccw:[{x:0,y:0},{x:-2,y:0},{x:1,y:0},{x:-2,y:1},{x:1,y:-2}]}],ControlGroup.prototype.isLegalPosition=function(t,i){var e,s=this.blocks;for(e=0;e<4;e+=1)if(s[e].isPosition(t,i))return!0;return this.isLegalCallback(t,i)},ControlGroup.prototype.shift=function(t){var i,e=t?-1:1;for(i=0;i<4;i+=1)if(!this.isLegalPosition(this.blocks[i].getX()+e,this.blocks[i].getY()))return!1;for(this.lastWasSpin=!1,this.baseX+=e,i=0;i<this.blocks.length;i+=1)this.blocks[i].moveBlock(e,0);return this.updateBottomedState(),!0},ControlGroup.prototype.updateBottomedState=function(){var t;for(t=0;t<this.blocks.length;t+=1)if(!this.isLegalPosition(this.blocks[t].getX(),this.blocks[t].getY()+1))return void(this.bottomed=!0);this.bottomed=!1},ControlGroup.prototype.drop=function(){var t;if(!this.bottomed){for(this.lastWasSpin=!1,this.baseY+=1,t=0;t<this.blocks.length;t+=1)this.blocks[t].moveBlock(0,1);this.updateBottomedState()}},ControlGroup.prototype.isBottomed=function(){return this.bottomed},ControlGroup.prototype.turn=function(t){var i,e,s=null,o=t?"cw":"ccw",r=this.kickOffsets[this.dir][o];for(e=0;e<r.length&&(i=r[e],!(s=this.tryTurn(t,i)));e+=1);if(!s)return!1;for(this.lastWasSpin=!0,e=0;e<4;e+=1)this.blocks[e].setPosition(s[e].x,s[e].y);return this.baseX+=i.x,this.baseY+=i.y,t?(this.dir+=1,4===this.dir&&(this.dir=0)):(this.dir-=1,-1===this.dir&&(this.dir=3)),this.updateBottomedState(),!0},ControlGroup.prototype.tryTurn=function(t,i){var e,s,o,r,n,a,h=[];if("block"===this.spin)for(n=0;n<this.blocks.length;n+=1)e=(t?-1:1)*(this.blocks[n].blockY-this.baseY)+this.baseX+i.x,s=(t?1:-1)*(this.blocks[n].blockX-this.baseX)+this.baseY+i.y,h[n]={x:e,y:s};else for(n=0;n<this.blocks.length;n+=1)(o=this.blocks[n].blockX-this.baseX)>=0&&(o+=1),(r=this.blocks[n].blockY-this.baseY)>=0&&(r+=1),(e=(t?-1:1)*r)>0&&(e-=1),(s=(t?1:-1)*o)>0&&(s-=1),h[n]={x:e+this.baseX+i.x,y:s+this.baseY+i.y};for(n=0;n<4;n+=1)if(a=h[n],!this.isLegalPosition(a.x,a.y))return null;return h},ControlGroup.prototype.getFallPositions=function(){for(var t,i,e=[],s=0,o=!0;o;)for(s+=1,t=0;t<4&&o;t+=1)i=this.blocks[t],this.isLegalPosition(i.getX(),i.getY()+s)||(s-=1,o=!1);for(t=0;t<4;t+=1)i=this.blocks[t],e.push({x:i.getX(),y:i.getY()+s});return{dist:s,positions:e}},ControlGroup.prototype.fall=function(){var t,i,e=this.getFallPositions(),s=e.positions,o=e.dist;for(0!==o&&(this.lastWasSpin=!1),t=0;t<4;t+=1)i=s[t],this.blocks[t].setPosition(i.x,i.y);return this.bottomed=!0,o},ControlGroup.prototype.configurePreviewBlocks=function(t){var i,e=this.getFallPositions().positions;for(i=0;i<4;i+=1)t[i].setPosition(e[i].x,e[i].y)},ControlGroup.prototype.getShape=function(){return this.shape},ControlGroup.prototype.getBlocks=function(){return this.blocks},ControlGroup.prototype.getTSpin=function(){var t,i,e=[{x:-1,y:-1},{x:1,y:-1},{x:1,y:1},{x:-1,y:1}],s=0,o=!1;if(!this.lastWasSpin)return null;if("t"!==this.shape)return null;for(0===this.dir?(e[0].miniCheck=!0,e[1].miniCheck=!0):1===this.dir?(e[1].miniCheck=!0,e[2].miniCheck=!0):2===this.dir?(e[2].miniCheck=!0,e[3].miniCheck=!0):3===this.dir&&(e[3].miniCheck=!0,e[0].miniCheck=!0),t=0;t<4;t+=1)i=e[t],this.isLegalPosition(this.baseX+i.x,this.baseY+i.y)?i.miniCheck&&(o=!0):s+=1;return s>=3?o?"mini":"normal":null};var redirCode,Background=function(t){var i,e,s;for(t=t||{},this.originX=(t.x||0)+FIELD_OFFSET_X,this.originY=(t.y||0)+FIELD_OFFSET_Y,this.width=10,this.height=20,this.tiles=[],i=0;i<this.width;i+=1)for(e=0;e<this.height;e+=1)s=new Block({empty:!0,blockX:i,blockY:e}),this.tiles.push(s);this.backdrop=new jaws.Sprite({image:"media/background/backdrop.png"}),this.backdrop.x=0,this.backdrop.y=0,this.topBar=new jaws.Sprite({image:"media/background/topbar.png"}),this.topBar.x=181,this.topBar.y=0,this.fullRedrawNeeded=!0};function RandomBag(t){for(this.available=[],this.queue=[];this.queue.length<t;)this.queue.push(this.nextAvailable())}function PreviewGroup(t,i){var e;for(this.blocks=[],this.shape=null,e=0;e<4;e+=1)this.blocks.push(new Block({boardOriginX:t,boardOriginY:i,blockX:0,blockY:0,shape:"i"}))}function ScoreTracker(t,i,e,s){this.level=1,this.score=0,this.linesRemaining=ScoreTracker.levelLines(this.level),this.scoreOutput=t,this.linesOutput=i,this.levelOutput=e,this.tickerOutput=s,this.curCombo=-1,this.lastWasBonus=!1,this.backToBackCount=0,this.isGameWon=!1,this.outputScore(),this.outputLines(),this.outputLevel()}function TtyBlock(t,i,e,s){var o;for(this.elem=document.getElementById(t),this.curPos=0,this.cursorShown=!1,this.timePassedType=0,this.timePassedFlash=0,this.typePeriod=30,this.flashPeriod=300,this.lines=[],o=0;o<i;o+=1)this.lines.push("");this.rollOverLength=e||9,this.rollOverRemove=s||3,this.backlog=[]}function Game(t,i,e){var s,o=this;for(this.firstLoop=!0,this.blocks=[],this.controlGroup=null,this.previewBlocks=[],s=0;s<4;s+=1)this.previewBlocks.push(new Block({blockX:-10,blockY:-10,preview:!0}));for(this.scoreOutput=new TtyBlock("scoreDiv",3),this.linesOutput=new TtyBlock("linesDiv",3),this.levelOutput=new TtyBlock("levelDiv",3),this.tickerOutput=new TtyBlock("tickerDiv",5),this.scoreTracker=new ScoreTracker(this.scoreOutput,this.linesOutput,this.levelOutput,this.tickerOutput),this.dropPeriod=this.scoreTracker.getLevelPeriod(),this.timeToNextDrop=this.dropPeriod,this.keyChargeTime=e,this.keyRepeatTime=i,this.bottomTimer=null,this.bottomLockTime=500,this.lastBottomedState=!1,this.lastTime=null,this.gameLost=!1,this.previewLength=5,this.randBag=new RandomBag(this.previewLength),this.previewGroups=[],s=0;s<this.previewLength;s+=1)this.previewGroups.push(new PreviewGroup(330,70*s+35));this.swapGroup=null,this.swapAllowed=!0,this.occupiedPositions={},this.input={shiftLeft:{autoRepeat:!0,handler:function(){o.controlGroup.shift(!0)&&o.resetLockCounter(!0)}},shiftRight:{autoRepeat:!0,handler:function(){o.controlGroup.shift(!1)&&o.resetLockCounter(!0)}},softDrop:{autoRepeat:!0,preCharged:!0,handler:function(){o.dropBlock(),o.scoreTracker.softDrop()}},hardDrop:{handler:function(){var t=o.controlGroup.fall();o.scoreTracker.hardDrop(t),o.lockBlocks()}},rotateLeft:{handler:function(){o.controlGroup.turn(!1)&&o.resetLockCounter(!0)}},rotateRight:{handler:function(){o.controlGroup.turn(!0)&&o.resetLockCounter(!0)}},swap:{handler:function(){o.swap()}}},this.inputMapping=t}function Button(t){var i,e=new jaws.Sprite(t);for(i in e)this[i]=e[i]}function TetrisControl(){var t=new Tetris(this);this.setup=function(){t.setup()},this.update=function(){t.update()},this.draw=function(){t.draw()},this.restart=function(){(t=new Tetris(this)).setup(),t.update()}}function Tetris(t){var i=null,e=null,s=0,o=!1,r=0,n=!1,a=!1,h=!1,c=null,l=this,p=null,u=null,d=null,f=null,g=new TtyBlock("gameEndDiv",10,20,1);this.setup=function(){var t,o=[];for(t in inputAssignments)o=o.concat(inputAssignments[t]);jaws.preventDefaultKeys(o),Tetris.currentInstance=l,e=new Game(inputAssignments,autoRepeatConfig,thresholdConfig),p=new Button({image:"media/buttons/continue.png",x:250,y:150}),u=new Button({image:"media/buttons/restart.png",x:250,y:200}),i=new Background,s=(new Date).getTime()},this.update=function(){var i,a=(new Date).getTime(),l=jaws.pressed("esc");if(null===d?(f=0,d=a):(f=a-d,d=a),n||h){if(n&&(l&&!o&&(s+=a-r,n=!1),c&&(p.isClicked(c.x,c.y)&&(s+=a-r,n=!1),u.isClicked(c.x,c.y))))return void t.restart()}else l&&!o?(r=a,n=!0):(e.update(a-s),(i=e.getResults())&&(h=!0,document.getElementById("gameEndContainer").setAttribute("class","gameEndOutputVisible"),g.addLine("GOOD GAME!!!"),g.addLine(""),g.addLine(""),i.won?g.addLine("You Win!"):g.addLine("Better Luck Next Time"),g.addLine(""),g.addLine(""),g.addLine("Re-directing you to"),g.addLine("the score screen..."),g.addLine(""),g.addLine(""),sendScoreRequest(i.score)));o=l,c=null},this.draw=function(){n||h?n?(i.draw(),e.draw(f),p.draw(),u.draw(),a=!0):(i.draw(),e.draw(f)):(i.draw(a),a&&(a=!1,Block.invalidateAll()),e.draw(f),Block.invalidFlushed()),g.draw(f)},this.mouseClicked=function(t,i){c={x:t,y:i}}}function redirectToScore(){window.location.replace("/ausgabe28/tetris/scoreScreen.html?tempRef="+redirCode)}function sendScoreRequest(t){var i;(i=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")).onreadystatechange=function(){4==i.readyState&&200==i.status&&(redirCode=i.responseText)}}Background.prototype.draw=function(t){var i;if(this.fullRedrawNeeded||t){for(this.backdrop.draw(),i=0;i<this.tiles.length;i+=1)this.tiles[i].draw();this.fullRedrawNeeded=!1}else for(this.topBar.draw(),jaws.context.fillstyle="#000D00",jaws.context.fillRect(24,42,118,60),jaws.context.fillRect(457,18,107,341),i=0;i<this.tiles.length;i+=1)this.tiles[i].drawIfInvalid()},RandomBag.initialList=["i","o","j","l","z","s","t"],RandomBag.prototype.getQueue=function(){return this.queue},RandomBag.prototype.popQueue=function(){var t=this.queue.shift();return this.queue.push(this.nextAvailable()),t},RandomBag.prototype.nextAvailable=function(){var t;return 0===this.available.length&&(this.available=RandomBag.initialList.slice(0)),t=Math.floor(Math.random()*this.available.length),this.available.splice(t,1)[0]},PreviewGroup.prototype.setShape=function(t){var i,e=SHAPES[t];for(this.shape=t,i=0;i<4;i+=1)this.blocks[i].setPosition(e.pos[i].x,e.pos[i].y),this.blocks[i].setColor(t,!1)},PreviewGroup.prototype.getShape=function(){return this.shape},PreviewGroup.prototype.draw=function(){var t;for(t=0;t<4;t+=1)this.blocks[t].draw()},ScoreTracker.levelLines=function(t){return 5*t},ScoreTracker.prototype.updateScore=function(t){var i,e=0,s=!1,o=0,r=[];if(t.miniT)r.push("T Spin Mini"),e+=1,o+=100*this.level,1===t.lines&&(e+=1,o+=100*this.level);else if(t.normalT)switch(t.lines){case 0:r.push("T Spin"),e+=4,o+=400*this.level;break;case 1:r.push("T Spin Single"),e+=8,s=!0,o+=800*this.level;break;case 2:r.push("T Spin Double"),e+=12,s=!0,o+=1200*this.level;break;case 3:r.push("T SPIN TRIPLE"),e+=16,s=!0,o+=1600*this.level}else if(t.lines>0)switch(t.lines){case 1:r.push("Single"),e+=1,o+=100*this.level;break;case 2:r.push("Double"),e+=3,o+=300*this.level;break;case 3:r.push("Triple"),e+=5,o+=500*this.level;break;case 4:r.push("TETRIS"),e+=8,s=!0,o+=800*this.level}if(e>0?(this.curCombo+=1,e+=Math.floor(.5*this.curCombo),o+=50*this.curCombo*this.level,this.curCombo>=1&&r.push("Combo x"+this.curCombo)):this.curCombo=-1,this.lastWasBonus&&s?(r.push("Back-to-Back"),this.backToBackCount+=1,e=Math.floor(1.5*e),o+=.5*this.backToBackCount*o):this.backToBackCount=0,t.lines>0&&(this.lastWasBonus=s),this.linesRemaining-=e,this.linesRemaining<=0&&(this.level<15?(this.level+=1,this.linesRemaining=ScoreTracker.levelLines(this.level)):this.isGameWon=!0,this.outputLevel()),e>0&&this.outputLines(),this.score+=o,this.outputScore(),0===r.length)this.tickerOutput.addLine("");else for(i=0;i<r.length;i+=1)this.tickerOutput.addLine(r[i])},ScoreTracker.prototype.softDrop=function(){this.score+=1},ScoreTracker.prototype.hardDrop=function(t){this.score+=2*t},ScoreTracker.prototype.getLinesRemaining=function(){return this.linesRemaining},ScoreTracker.prototype.getScore=function(){return this.score},ScoreTracker.prototype.getLevel=function(){return this.level},ScoreTracker.prototype.getLevelPeriod=function(){var t=[1e3,800,600,470,380,250,200,160,130,90,50,27,20,15,10];return t[this.level<t.length?this.level:t.length-1]},ScoreTracker.prototype.gameWon=function(){return this.isGameWon},ScoreTracker.prototype.getResults=function(){return{score:this.score,level:this.level,won:this.isGameWon}},ScoreTracker.prototype.outputScore=function(){this.scoreOutput.addLine("Score:"),this.scoreOutput.addLine(""+this.score),this.scoreOutput.addLine("")},ScoreTracker.prototype.outputLines=function(){this.linesOutput.addLine("Lines:"),this.linesOutput.addLine(""+this.linesRemaining),this.linesOutput.addLine("")},ScoreTracker.prototype.outputLevel=function(){this.levelOutput.addLine("Level:"),this.levelOutput.addLine(""+this.level),this.levelOutput.addLine("")},TtyBlock.prototype.draw=function(t){var i,e,s="";for(this.timePassedType+=t;this.timePassedType>this.typePeriod;)this.curPos+=1,this.timePassedType-=this.typePeriod;if(e=this.lines[this.lines.length-1],this.curPos>e.length)for(this.timePassedFlash+=t;this.timePassedFlash>this.flashPeriod;)this.cursorShown=!this.cursorShown,this.timePassedFlash-=this.flashPeriod;for(this.curPos>e.length&&this.backlog.length>0&&(this.lines.shift(),e=this.backlog.shift(),this.lines.push(e),this.curPos=0),i=0;i<this.lines.length-1;i+=1)s+=this.lines[i]+"<br/>";s+=e.slice(0,Math.min(this.curPos,e.length)),this.cursorShown&&(s+="_"),s.replace(">","&gt"),this.elem.innerHTML=s},TtyBlock.prototype.addLine=function(t){this.backlog.length>this.rollOverLength&&this.backlog.splice(this.backlog.length-this.rollOverRemove,this.rollOverRemove),this.backlog.push("   > "+t)},Game.prototype.newBlock=function(t){var i,e,s=this,o=this.randBag.popQueue(),r=[];for(this.dropPeriod=this.scoreTracker.getLevelPeriod(),e=0;e<4;e+=1)i=new Block({blockX:-10,blockY:-10,shape:o,occupiedPositions:this.occupiedPositions}),r.push(i),this.blocks.push(i);this.controlGroup=new ControlGroup(r,o,(function(t,i){return s.isLegalPosition(t,i)})),this.controlGroup.isIllegalStart&&(this.gameLost=!0),t||(this.swapAllowed=!0),this.updatePreviews(this.randBag.getQueue())},Game.prototype.processInput=function(t){var i,e,s,o;for(actionType in this.inputMapping){for(i=this.inputMapping[actionType],s=this.input[actionType],e=!1,o=0;o<i.length;o+=1)jaws.pressed(i[o])&&(e=!0);e?(s.lastState||(s.handler(),s.lastState=!0,s.charged=!!s.preCharged,s.holdTime=0),s.autoRepeat&&(s.holdTime+=t,!s.charged&&s.holdTime>this.keyChargeTime&&(s.holdTime-=this.keyChargeTime,s.handler(),s.charged=!0),s.charged&&s.holdTime>this.keyRepeatTime&&(s.holdTime-=this.keyRepeatTime,s.handler()))):s.lastState=!1}},Game.prototype.update=function(t){var i,e,s;if(this.firstLoop&&(this.firstLoop=!1,this.newBlock(),this.lastTime=t),e=(i=t)-this.lastTime,this.lastTime=i,this.processInput(e),this.controlGroup.isBottomed()?(this.lastBottomedState?(this.bottomTimer-=e,(this.bottomTimer<=0||this.slideCount>=15)&&this.lockBlocks()):this.resetLockCounter(!1),this.lastBottomedState=!0):(this.lastBottomedState=!1,this.applyGravity(e)),this.controlGroup)this.controlGroup.configurePreviewBlocks(this.previewBlocks);else for(s=0;s<4;s+=1)this.previewBlocks[s].setPosition(-10,-10)},Game.prototype.draw=function(t){var i;for(this.scoreOutput.draw(t),this.linesOutput.draw(t),this.levelOutput.draw(t),this.tickerOutput.draw(t),i=0;i<4;i+=1)this.previewBlocks[i].drawIfInvalid();for(this.swapGroup&&this.swapGroup.draw(),i=0;i<this.previewGroups.length;i+=1)this.previewGroups[i].draw();for(i=0;i<this.blocks.length;i+=1)this.blocks[i].drawIfInvalid()},Game.prototype.isLegalPosition=function(t,i){return!this.occupiedPositions[t+","+i]&&!(t>=10||t<0||i>=20)},Game.prototype.dropBlock=function(t){t||(this.timeToNextDrop=this.dropPeriod),this.controlGroup.drop()},Game.prototype.getRows=function(){var t,i,e=[],s=[];for(t=0;t<20;t+=1)e[t]=0;for(t=0;t<this.blocks.length;t+=1)e[i=this.blocks[t].getY()]+=1,10===e[i]&&s.push(i);return s},Game.prototype.removeRows=function(t){var i,e,s,o,r={},n={};for(i=-4;i<20;i+=1)r[i]=0;for(i=0;i<t.length;i+=1)for(n[t[i]]=!0,e=-4;e<t[i];e+=1)r[e]+=1;for(i=0;i<this.blocks.length;i+=1)n[o=(s=this.blocks[i]).getY()]?(this.removeBlock(i),i-=1):s.setPosition(s.getX(),s.getY()+r[o])},Game.prototype.removeBlock=function(t){return this.blocks[t].kill(),this.blocks.splice(t,1)},Game.prototype.applyGravity=function(t){for(this.timeToNextDrop-=t;this.timeToNextDrop<0&&!this.controlGroup.isBottomed();)this.dropBlock(!0),this.timeToNextDrop+=this.dropPeriod;this.controlGroup.isBottomed()&&(this.timeToNextDrop=this.dropPeriod)},Game.prototype.updatePreviews=function(t){var i;for(i=0;i<t.length;i+=1)this.previewGroups[i].setShape(t[i])},Game.prototype.swap=function(){var t,i,e,s=this.controlGroup.getShape(),o=this.controlGroup.getBlocks(),r=[],n=this;if(this.swapAllowed){for(this.swapAllowed=!1,this.resetLockCounter(!1),t=0;t<this.blocks.length;t+=1)for(i=0;i<4;i+=1)o[i]===this.blocks[t]&&(this.removeBlock(t),t-=1);if(this.swapGroup){for(e=this.swapGroup.getShape(),t=0;t<4;t+=1)r.push(new Block({blockX:-10,blockY:-10,shape:e,occupiedPositions:this.occupiedPositions})),this.blocks.push(r[t]);return this.controlGroup=new ControlGroup(r,e,(function(t,i){return n.isLegalPosition(t,i)})),void this.swapGroup.setShape(s)}this.swapGroup=new PreviewGroup(-100,60),this.swapGroup.setShape(s),this.newBlock(!0)}},Game.prototype.lockBlocks=function(){var t,i=this.controlGroup.getTSpin(),e={};"mini"===i?e.miniT=!0:"normal"===i&&(e.normalT=!0),t=this.getRows(),e.lines=t.length,t.length>0&&this.removeRows(t),this.scoreTracker.updateScore(e),this.newBlock(),this.resetLockCounter(!1)},Game.prototype.resetLockCounter=function(t){t?this.slideCount+=1:this.slideCount=0,this.bottomTimer=this.bottomLockTime},Game.prototype.getResults=function(){return this.gameLost||this.scoreTracker.gameWon()?this.scoreTracker.getResults():null},Button.prototype.isClicked=function(t,i){return this.rect().collidePoint(t,i)},FIELD_OFFSET_X=180,FIELD_OFFSET_Y=12,window.onload=function(){loadGameControls(),jaws.assets.add("media/blueblock.png"),jaws.assets.add("media/cyanblock.png"),jaws.assets.add("media/greenblock.png"),jaws.assets.add("media/orangeblock.png"),jaws.assets.add("media/purpleblock.png"),jaws.assets.add("media/redblock.png"),jaws.assets.add("media/yellowblock.png"),jaws.assets.add("media/greyblock.png"),jaws.assets.add("media/emptyblock.png"),jaws.assets.add("media/buttons/continue.png"),jaws.assets.add("media/buttons/restart.png"),jaws.assets.add("media/background/backdrop.png"),jaws.assets.add("media/background/topbar.png"),jaws.start(TetrisControl)};var inputAssignments={shiftLeft:["left"],shiftRight:["right"],softDrop:["down"],rotateLeft:["z"],rotateRight:["x","up"],swap:["shift","c"],hardDrop:["space"]},autoRepeatConfig=50,thresholdConfig=200;function loadGameControls(){var t,i,e=["rotateLeft","rotateRight","shiftLeft","shiftRight","softDrop","hardDrop","swap"];if("TRUE"===readCookie("customControls"))for(t=0;t<e.length;t+=1)i=readCookie(e[t]),document.getElementById(e[t]).innerHTML=i,inputAssignments[e[t]]=[i.toLowerCase()];var s=readCookie("autoRepeat");null!==s&&(autoRepeatConfig=parseInt(s));var o=readCookie("threshold");null!=o&&(thresholdConfig=parseInt(o))}